name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

# Permissions at workflow level so OIDC token works
permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  # Authorization check - only allow admins, owners, or github-actions
  authorize:
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.check-auth.outputs.authorized }}
    steps:
      - name: Check authorization
        id: check-auth
        uses: actions/github-script@v7
        with:
          script: |
            let actor;
            let body;

            // Determine actor and body based on event type
            if (context.eventName === 'issue_comment' || context.eventName === 'pull_request_review_comment') {
              actor = context.payload.comment.user.login;
              body = context.payload.comment.body;
            } else if (context.eventName === 'pull_request_review') {
              actor = context.payload.review.user.login;
              body = context.payload.review.body || '';
            } else if (context.eventName === 'issues') {
              actor = context.payload.issue.user.login;
              body = (context.payload.issue.body || '') + ' ' + (context.payload.issue.title || '');
            } else {
              core.setOutput('authorized', 'false');
              return;
            }

            // Check if @claude is mentioned
            if (!body.toLowerCase().includes('@claude')) {
              console.log('No @claude mention found');
              core.setOutput('authorized', 'false');
              return;
            }

            // Allow github-actions bot
            if (actor === 'github-actions[bot]' || actor === 'github-actions') {
              console.log('Authorized: github-actions bot');
              core.setOutput('authorized', 'true');
              return;
            }

            // Check if actor is admin/owner/write
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: actor
              });

              const hasWriteAccess = ['admin', 'write'].includes(permission.permission);
              console.log(`User ${actor} has permission: ${permission.permission}, authorized: ${hasWriteAccess}`);

              if (hasWriteAccess) {
                core.setOutput('authorized', 'true');
              } else {
                console.log(`User ${actor} does not have write access - ignoring`);
                core.setOutput('authorized', 'false');
              }
            } catch (e) {
              console.log(`Could not check permissions for ${actor}: ${e.message}`);
              core.setOutput('authorized', 'false');
            }

  claude:
    needs: authorize
    if: needs.authorize.outputs.authorized == 'true'
    runs-on: ubuntu-latest

    env:
      XHR_FETCH_URL: ${{ secrets.XHR_FETCH_URL }}
      XHR_FETCH_KEY: ${{ secrets.XHR_FETCH_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Use explicit github_token to avoid OIDC issues with issue_comment triggers
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Reuse the same comment on PRs instead of creating new ones
          reuse_pr_comment: true

          # Allow Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Tools Claude can use
          allowed_tools: "Bash,Read,Edit,Write,Glob,Grep,WebFetch,WebSearch"

          # Custom instructions for this repository
          custom_instructions: |
            ## Ski Lift Status Repository

            This repo extracts lift and run status from ski resort websites.

            ### Key Commands
            - `npm install` - Install dependencies
            - `node src/ski_lift_status/configs/runner.js <resort-id>` - Test a specific resort config
            - `node src/ski_lift_status/configs/runner.js --all` - Test all resort configs

            ### Project Structure
            - `src/ski_lift_status/configs/runner.js` - Main extraction logic (HTTP requests only, no browser)
            - `src/ski_lift_status/configs/resorts/` - Individual resort JSON config files
            - `data/lifts.csv` and `data/runs.csv` - OpenSkiMap reference data

            ### Architecture Principles
            - Prefer JSON API endpoints over HTML scraping
            - Use direct HTTP requests only (no browser rendering)
            - Every JS-heavy site has an underlying API - use XHR Fetcher to discover it

            ### XHR Fetcher (for discovering APIs)
            If XHR_FETCH_URL env var is set, you can discover hidden APIs:
            ```bash
            curl -s -X POST "$XHR_FETCH_URL/analyze" \
              -H "Authorization: Bearer $XHR_FETCH_KEY" \
              -H "Content-Type: application/json" \
              -d '{"url": "https://example.com/lift-status", "timeout": 60000}'
            ```

            ### Success Criteria for Resort Configs
            - At least 2 lifts extracted
            - At least 2 runs extracted
            - No errors
