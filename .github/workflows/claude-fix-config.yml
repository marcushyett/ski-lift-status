name: Claude Code - Fix Resort Config

on:
  issues:
    types: [opened, labeled]

# Only allow one Claude Code run per issue at a time
concurrency:
  group: claude-fix-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  check-authorization:
    name: Check Authorization
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
      is_automated: ${{ steps.check.outputs.is_automated }}

    steps:
      - name: Check if authorized to run
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const creator = issue.user.login;
            const labels = issue.labels.map(l => l.name);

            // Must have the config-fix-needed label
            if (!labels.includes('config-fix-needed')) {
              console.log('Issue does not have config-fix-needed label');
              core.setOutput('authorized', 'false');
              core.setOutput('is_automated', 'false');
              return;
            }

            // Skip if already has cannot-fix or in-progress label
            if (labels.includes('cannot-fix') || labels.includes('claude-in-progress')) {
              console.log('Issue already processed or in progress');
              core.setOutput('authorized', 'false');
              core.setOutput('is_automated', 'false');
              return;
            }

            // Check if the issue was created by the automated workflow (has 'automated' label)
            const isAutomated = labels.includes('automated');
            core.setOutput('is_automated', isAutomated ? 'true' : 'false');

            if (isAutomated) {
              console.log('Issue was created by automated workflow - authorized');
              core.setOutput('authorized', 'true');
              return;
            }

            // For manually created issues, check if creator is admin/owner
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: creator
              });

              const isAdminOrOwner = ['admin', 'write'].includes(permission.permission);
              console.log(`User ${creator} has permission: ${permission.permission}`);
              core.setOutput('authorized', isAdminOrOwner ? 'true' : 'false');
            } catch (e) {
              console.log(`Could not check permissions for ${creator}: ${e.message}`);
              core.setOutput('authorized', 'false');
            }

  fix-config:
    name: Fix Resort Configuration
    needs: check-authorization
    if: needs.check-authorization.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write

    env:
      XHR_FETCH_URL: ${{ secrets.XHR_FETCH_URL }}
      XHR_FETCH_KEY: ${{ secrets.XHR_FETCH_KEY }}
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Add in-progress label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['claude-in-progress']
            });

      - name: Extract resort ID from issue title
        id: extract
        run: |
          TITLE="${{ github.event.issue.title }}"
          # Extract resort ID from [resort-id] in title
          RESORT_ID=$(echo "$TITLE" | grep -oP '(?<=\[)[^\]]+(?=\])')
          echo "resort_id=$RESORT_ID" >> $GITHUB_OUTPUT
          echo "Extracted resort ID: $RESORT_ID"

      - name: Create branch for fix
        id: branch
        run: |
          BRANCH_NAME="claude/fix-${{ steps.extract.outputs.resort_id }}-issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run Claude Code to fix the issue
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          model: claude-sonnet-4-20250514
          timeout_minutes: 20
          allowed_tools: "Bash,Read,Edit,Write,Glob,Grep,WebFetch"
          prompt: |
            You are fixing a resort configuration issue. Here's the context:

            ## Issue Details
            ${{ github.event.issue.body }}

            ## Your Task
            1. First, read the current configuration for the resort in `src/ski_lift_status/configs/resorts/${{ steps.extract.outputs.resort_id }}.json`
            2. Test the current configuration: `cd src/ski_lift_status/configs && node runner.js ${{ steps.extract.outputs.resort_id }}`
            3. If the XHR Fetcher is available (check if XHR_FETCH_URL env var exists), use it to discover API endpoints
            4. Look at how similar platforms are implemented in `runner.js`
            5. Make the necessary fixes to get at least 2 lifts and 2 runs extracted
            6. Test your fix by running `node runner.js ${{ steps.extract.outputs.resort_id }}` again

            ## Important Guidelines
            - Prefer JSON API endpoints over HTML scraping
            - The runner.js file performs direct HTTP requests only - NO browser automation
            - Look at the CLAUDE.md file for architecture principles and known API endpoints
            - If you need to add a new platform extractor, follow the patterns in runner.js
            - Each resort has its own config file in `src/ski_lift_status/configs/resorts/<resort-id>.json`

            ## Success Criteria
            Your fix is successful when `node runner.js ${{ steps.extract.outputs.resort_id }}` returns:
            - At least 2 lifts (lifts array length >= 2)
            - At least 2 runs (runs array length >= 2)
            - No errors

            After making changes, run the test command and report the results.
            If you cannot fix the issue after multiple attempts, explain what you tried and why it didn't work.

      - name: Test the fix
        id: test
        run: |
          cd src/ski_lift_status/configs
          OUTPUT=$(node runner.js ${{ steps.extract.outputs.resort_id }} 2>&1) || true
          echo "$OUTPUT"

          # Check if successful
          LIFTS=$(echo "$OUTPUT" | grep -oP '"lifts":\s*\[' | wc -l || echo "0")
          LIFTS_COUNT=$(echo "$OUTPUT" | node -e "
            let data = '';
            process.stdin.on('data', chunk => data += chunk);
            process.stdin.on('end', () => {
              try {
                const parsed = JSON.parse(data);
                console.log(parsed.lifts?.length || 0);
              } catch(e) {
                console.log(0);
              }
            });
          " 2>/dev/null || echo "0")

          RUNS_COUNT=$(echo "$OUTPUT" | node -e "
            let data = '';
            process.stdin.on('data', chunk => data += chunk);
            process.stdin.on('end', () => {
              try {
                const parsed = JSON.parse(data);
                console.log(parsed.runs?.length || 0);
              } catch(e) {
                console.log(0);
              }
            });
          " 2>/dev/null || echo "0")

          echo "lifts_count=$LIFTS_COUNT" >> $GITHUB_OUTPUT
          echo "runs_count=$RUNS_COUNT" >> $GITHUB_OUTPUT

          if [ "$LIFTS_COUNT" -ge 2 ] && [ "$RUNS_COUNT" -ge 2 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "$(cat <<'EOF'
          fix(${{ steps.extract.outputs.resort_id }}): Update resort configuration

          Fixes #${{ github.event.issue.number }}

          - Updated configuration for ${{ steps.extract.outputs.resort_id }}
          - Lifts: ${{ steps.test.outputs.lifts_count }}
          - Runs: ${{ steps.test.outputs.runs_count }}
          EOF
          )"
          git push -u origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && steps.test.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `fix(${{ steps.extract.outputs.resort_id }}): Fix resort configuration`,
              body: `## Summary

            Fixes #${{ github.event.issue.number }}

            This PR fixes the resort configuration for \`${{ steps.extract.outputs.resort_id }}\`.

            ### Test Results
            - **Lifts extracted:** ${{ steps.test.outputs.lifts_count }}
            - **Runs extracted:** ${{ steps.test.outputs.runs_count }}

            ### Changes Made
            See commit for details.

            ---
            *This PR was automatically created by Claude Code.*`,
              head: '${{ steps.branch.outputs.branch_name }}',
              base: 'main'
            });

            console.log(`Created PR #${pr.number}`);

            // Comment on the issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `I've created a pull request to fix this issue: #${pr.number}\n\n**Test Results:**\n- Lifts: ${{ steps.test.outputs.lifts_count }}\n- Runs: ${{ steps.test.outputs.runs_count }}\n\nPlease review and merge if the fix looks correct.`
            });

            // Remove in-progress label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              name: 'claude-in-progress'
            }).catch(() => {});

      - name: Handle failure - no changes or tests still failing
        if: steps.changes.outputs.has_changes == 'false' || steps.test.outputs.success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
            const testSuccess = '${{ steps.test.outputs.success }}' === 'true';
            const liftsCount = '${{ steps.test.outputs.lifts_count }}';
            const runsCount = '${{ steps.test.outputs.runs_count }}';

            let message = '';
            if (!hasChanges) {
              message = `I attempted to fix this issue but couldn't determine the necessary changes.\n\n`;
            } else if (!testSuccess) {
              message = `I made changes but the tests are still failing:\n- Lifts: ${liftsCount} (need at least 2)\n- Runs: ${runsCount} (need at least 2)\n\n`;
            }

            message += `**Claude's analysis:** ${{ steps.claude.outputs.conclusion || 'See workflow logs for details.' }}\n\n`;
            message += `This issue may require manual intervention. A human developer should:\n`;
            message += `1. Check if the resort's status page has changed\n`;
            message += `2. Use the XHR Fetcher tool to discover new API endpoints\n`;
            message += `3. Check similar resorts on the same platform for patterns\n\n`;
            message += `Adding the \`cannot-fix\` label for human review.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: message
            });

            // Add cannot-fix label and remove in-progress
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['cannot-fix']
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              name: 'claude-in-progress'
            }).catch(() => {});

      - name: Cleanup on unexpected failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `The automated fix workflow encountered an unexpected error. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              name: 'claude-in-progress'
            }).catch(() => {});
